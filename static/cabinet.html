<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet House | –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="brand">Gourmet House</div>
        <div class="auth-links">
            <button id="logoutButton" class="btn-primary">–í—ã–π—Ç–∏</button>
        </div>
    </nav>

    <main class="container">
        <h2 class="section-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar">üë§</div>
                <h3 id="userEmail" class="profile-email">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
            </div>

            <div class="profile-details">
                <div class="detail-item">
                    <span class="detail-label">–ò–º—è:</span>
                    <span id="userName" class="detail-value">–ù–µ —É–∫–∞–∑–∞–Ω–æ</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                    <span id="userPhone" class="detail-value">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–ê–¥—Ä–µ—Å:</span>
                    <span id="userAddress" class="detail-value">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                </div>
            </div>
        </div>

        <div class="edit-form" id="editForm" style="display: none;">
            <h3 class="actions-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label>–ò–º—è:</label>
                    <input type="text" id="editName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                    <input type="tel" id="editPhone" placeholder="+7 (999) 999-99-99">
                </div>
                <div class="form-group">
                    <label>–ê–¥—Ä–µ—Å:</label>
                    <input type="text" id="editAddress" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn-link" onclick="hideEditForm()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>

        <section class="account-actions">
            <h3 class="actions-title">–î–µ–π—Å—Ç–≤–∏—è</h3>
            <div class="actions-grid">
                <button class="action-btn" onclick="showEditForm()">
                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                </button>
                </div>

            <div class="security-section">
                <h3>–ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h3>
                <p>–í–∞—à Chat ID: <span id="telegramChatId">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω</span></p>
                <button onclick="connectTelegram()" class="btn-primary">
                    –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram
                </button>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                <p>–ú–æ—Å–∫–≤–∞, —É–ª. –ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è, 15</p>
                <p>+7 (495) 123-45-67</p>
            </div>
        </div>
    </footer>

    <script>
        async function connectTelegram() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/user/telegram/request-link', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞');
                }

                const data = await response.json();
                alert(`–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É:\n/start ${data.temp_token}`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è Telegram');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const userResponse = await fetch('http://localhost:8000/users/me/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!userResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

                const userData = await userResponse.json();

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                document.getElementById('userEmail').textContent = userData.email;
                document.getElementById('userName').textContent = userData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('userPhone').textContent = userData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω';
                document.getElementById('userAddress').textContent = userData.address || '–ù–µ —É–∫–∞–∑–∞–Ω';

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Telegram
                const telegramResponse = await fetch('http://localhost:8000/users/me/telegram', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const telegramChatIdSpan = document.getElementById('telegramChatId');
                const connectTelegramButton = document.querySelector('.security-section button');

                if (telegramResponse.ok) {
                    const telegramData = await telegramResponse.json();
                    if (telegramData.telegram_id) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ telegram_id –Ω–µ null –∏ –Ω–µ undefined
                        telegramChatIdSpan.textContent = telegramData.telegram_id;
                        connectTelegramButton.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    } else {
                        telegramChatIdSpan.textContent = '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
                        connectTelegramButton.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    }
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ Telegram');
                    telegramChatIdSpan.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                    connectTelegramButton.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è');
                logout();
            }
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function showEditForm() {
            document.getElementById('editForm').style.display = 'block';
            document.getElementById('editName').value = document.getElementById('userName').textContent;
            document.getElementById('editPhone').value = document.getElementById('userPhone').textContent;
            document.getElementById('editAddress').value = document.getElementById('userAddress').textContent;
        }

        // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function hideEditForm() {
            document.getElementById('editForm').style.display = 'none';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const updateData = {
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                address: document.getElementById('editAddress').value
            };

            try {
                const response = await fetch('http://localhost:8000/user/profile', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                document.getElementById('userName').textContent = updateData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('userPhone').textContent = updateData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω';
                document.getElementById('userAddress').textContent = updateData.address || '–ù–µ —É–∫–∞–∑–∞–Ω';

                hideEditForm();
                alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + error.message);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', loadUserData);
        document.getElementById('logoutButton').addEventListener('click', logout);
    </script>
</body>
</html>